<!DOCTYPE html>
<html>
    <head>
        <title>Choice Commitment Task</title>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-custom/custom-jspsych-four-image-keyboard-response.js"></script>
        <script src="jspsych-custom/custom-jspsych-two-image-keyboard-response.js"></script>
        <script src="functions/functions.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body></body>
    <script>

        var trial_count = 0;
        var n_trials = 10;
        var feedback = [];
        var timeline = [];
        var init = jsPsych.randomization.sampleWithoutReplacement([0, 1, 2, 3], 2);
        var preObject = [];
        preObject[0] = init[0];
        preObject[1] = init[1];
        preObject[2] = [[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]];
        var outcomes = makeMatrix(10, 10, [0.75, 0.5, 0.5, 0.25], 4);

        var welcome = {
            type: "html-button-response",
            stimulus: 'Welcome to the experiment.',
            choices: ['Begin']
        }

        var instructions1 = {
            type: "html-keyboard-response",
            stimulus: "<p>Phase 1</p><p>In this experiment, you will see 2 shapes (either a circle, square, " +
            " diamond, triangle) appear on the screen randomly paired.</p><p>You must " +
            "choose only <strong>1</strong> of the 2 shapes displayed on the screen during each " +
            "trial.</p><p>You will earn points based on your choices.</p><p>Your goal is to " +
            "accumulate as many points as possible by the end of the trials.</p><p>If you " +
            "choose the shape on the <strong>left</strong> side of the screen, press <strong>'a'</strong> " +
            "on the keyboard.</p><p>If you choose the shape on the <strong>right</strong> side of the " +
            "screen, press the letter <strong>'s'</strong> on the keyboard.</p>" +
            "<p>Press any key to begin.</p>",
        };

        var stimuli_display_p1 = {
            type: "2image-keyboard-response",
            stimulus1: function() {
                return "img/shape" + preObject[0] + ".png"
            },
            stimulus2: function() {
                return "img/shape" + preObject[1] + ".png"
            },
            choices: ['leftArrow', 'rightArrow'],
            data: {
                trial_phase: "choice",
                stimulus1: function() {
                    return "shape" + preObject[0]
                },
                stimulus2: function () {
                    return "shape" + preObject[1]
                },
            },
            on_finish: function(data) {
                if (data.key_press == 39) {
                    feedback = outcomes[0][preObject[1]][preObject[2][preObject[1]][1]]
                    preObject[2][preObject[1]][1] = preObject[2][preObject[1]][1] + 1
                    data.resp = "right"
                    data.choice = "shape" + preObject[1]
                } else if (data.key_press == 37) {
                    feedback = outcomes[0][preObject[0]][preObject[2][preObject[0]][1]]
                    preObject[2][preObject[0]][1] = preObject[2][preObject[0]][1] + 1
                    data.resp = "left"
                    data.choice = "shape" + preObject[0]
                } else {
                    data.resp = NULL
                    data.choice = NULL
                }
            }
        }

        choice_display_p1 = {
            type: "2image-keyboard-response",
            stimulus1: function() {
                return "img/shape" + preObject[0]  + ".png"
            },
            stimulus2: function() {
                return "img/shape" + preObject[1]  + ".png"
            },
            choices: [jsPsych.NO_KEYS],
            showchoice: function() {
                return jsPsych.data.get().last(1).values()[0].resp
            },
            trial_duration: 1000,
            data: {
                trial_phase: "resp_fb",
                stimulus1: function() {
                    return "shape" + preObject[0]
                },
                stimulus2: function () {
                    return "shape" + preObject[1]
                },
            },
            on_finish: function() {
                trial_count++
                preObject = dynDisp(preObject)
            }
        }

        var outcome_display_p1 = {
            type: "html-keyboard-response",
            stimulus: feedback,
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
        }

        var trial_p1 = [stimuli_display_p1, choice_display_p1, outcome_display_p1]

        var loop_p1 = {
            timeline: trial_p1,
            /*loop_function: function() {
                if (trial_count == n_trials.length) { // check number of correct responses in last n responses and change cor_choice if criteria for reversal are met
                    return false
                } else {
                    return true
                }
            } */
        }
        
        jsPsych.init({
            timeline: [welcome, instructions1, loop_p1],
            on_finish: function() {
                jsPsych.data.displayData();
            }
        });

/*
        var point_accumulation1 = {
            type: "html-keyboard-response",
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            stimulus: function() {

                var trials = jsPsych.data.get(accuracy).filter({accuracy});
                var all_trials = trials.filter({correct: true});
                var accuracy = Math.floor(Math.random()* 2);
                
                return "<p>"+accuracy+" point</p>";
            },
        }

        var point_accumulation2 = {
            type: "html-keyboard-response",
            choices: jsPsych.NO_KEYS,
            trial_duration: 1000,
            stimulus: function() {

                var trials = jsPsych.data.get(accuracy).filter({accuracy});
                var all_trials = trials.filter({correct: true});
                var accuracy = Math.round(all_trials.count());

                return "<p>"+accuracy+" total points</p>";
            },
        }
    
        var debrief_block1 = {
            type: "html-keyboard-response",
            stimulus: function() {

                var trials = jsPsych.data.get().filter({test_part: 'test'});
                var all_trials = trials.filter({correct: true});
                var accuracy = Math.round(all_trials.count() / 6 * 100);

                return "<p>You responded correctly on "+accuracy+"% of the trials.</p>"+
                "<p>Press any key to continue.</p>";         
            }
        }

        var choice_question = {
            type: "html-keyboard-response",
            stimulus: "<p>Choose your preferred shape</p>" +
            "<div style='width: 700px;'>" +
            "<div style='float: left;'><img src='img/Shapes.png'></img>" +
            "</div>"+
            "<p>If you choose <strong>circle</strong>, press the letter 'a' on the keyboard.</p><p>If " +
            "you choose <strong>square</strong>, press the letter 's' on the keyboard.</p><p>If " +
            "you choose <strong>diamond</strong>, press the letter 'd' on the keyboard.</p><p>If " +
            "you choose <strong>triangle</strong>, press the letter 'f' on the keyboard.</p>",
            choices: ['a', 's', 'd', 'f']
        }

        var question_block = {
            type: "html-button-response",
            stimulus: "How confident do you feel about your preferred choice of shape on a scale " +
            "of 1-10, with 1 being the least confident and 10 being the most confident?",
            choices: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']
        }

        var instructions2 = {
            type: "html-keyboard-response",
            stimulus: "<p>Phase 2</p><p>In this experiment, you will see 4 shapes (circle, square, " +
            " diamond, triangle) appear on  the screen.</p><p>You must " +
            "choose only <strong>1</strong> of the 4 shapes displayed on the screen during each " +
            "trial.</p><p> You will earn points based on your choices.</p><p>Your goal is to " +
            "accumulate as many points as possible by the end of the trials.</p><p>If you " +
            "choose the shape on the <strong>far left</strong> of the screen, press <strong>'a'</strong> on the keyboard.</p><p>If " +
            "you choose the shape in the <strong>middle left</strong> of the screen, press <strong>'s'</strong> on the keyboard.</p><p>If " +
            "you choose the shape in the <strong>middle right</strong> of the screen, press <strong>'d'</strong> on the keyboard.</p><p>If " +
            "you choose the shape on the <strong>far right</strong> of the screen, press  <strong>'f'</strong> on the keyboard.</p>" +
            "<p>Press any key to begin.</p>",
        };

        var trial_p2_1 = {
            type: "4image-keyboard-response",
            stimulus1: 'img/Circle.png', 
            stimulus2: 'img/Triangle.png',
            stimulus3: 'img/Diamond.png',
            stimulus4: 'img/Square.png', 
            choices: ['a', 's', 'd', 'f'],
            repetitions: 5,
            randomize_order: true,

        };

        var finish = {
            type: "html-keyboard-response",
            stimulus: 'Thank you for taking part in the experiment.'
        }
        */
    </script>
</html>